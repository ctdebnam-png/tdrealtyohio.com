<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bulk Outcomes - Outcome Tracker</title>
  <link rel="stylesheet" href="assets/admin.css">
</head>
<body>
  <div class="header">
    <h1>Bulk Outcome Recording</h1>
  </div>

  <div class="container">
    <!-- Filter Panel -->
    <div class="card">
      <h2 class="card-title">Filter Leads</h2>
      <div class="filters">
        <div class="form-group">
          <label for="filter-source">Source</label>
          <select id="filter-source">
            <option value="">All Sources</option>
            <option value="organic_search">Organic Search</option>
            <option value="paid_ads">Paid Ads</option>
            <option value="referral">Referral</option>
            <option value="social_media">Social Media</option>
            <option value="zillow">Zillow</option>
          </select>
        </div>
        <div class="form-group">
          <label for="filter-geo">Geo</label>
          <select id="filter-geo">
            <option value="">All Geos</option>
            <option value="dublin_oh">Dublin OH</option>
            <option value="columbus_oh">Columbus OH</option>
            <option value="hilliard_oh">Hilliard OH</option>
            <option value="westerville_oh">Westerville OH</option>
            <option value="powell_oh">Powell OH</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tier</label>
          <div>
            <label style="display: inline-block; margin-right: 1rem;">
              <input type="checkbox" value="A" checked> A
            </label>
            <label style="display: inline-block; margin-right: 1rem;">
              <input type="checkbox" value="B" checked> B
            </label>
            <label style="display: inline-block; margin-right: 1rem;">
              <input type="checkbox" value="C"> C
            </label>
            <label style="display: inline-block;">
              <input type="checkbox" value="D"> D
            </label>
          </div>
        </div>
      </div>
      <button onclick="searchLeads()" class="btn btn-primary">Search Leads</button>
    </div>

    <!-- Lead Results -->
    <div class="card" id="results-card" style="display: none;">
      <h2 class="card-title">
        Matching Leads
        <span id="selected-count" style="float: right; font-size: 0.875rem; font-weight: normal;">0 selected</span>
      </h2>
      <div id="results-table-container">
        <table class="table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
              <th>Lead ID</th>
              <th>Source</th>
              <th>Geo</th>
              <th>Tier</th>
              <th>Last Activity</th>
            </tr>
          </thead>
          <tbody id="results-tbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Bulk Action Panel -->
    <div class="card" id="action-card" style="display: none;">
      <h2 class="card-title">Apply Outcome to Selected Leads</h2>
      <form id="bulk-form">
        <div class="form-group">
          <label for="bulk-outcome-type">Outcome Type*</label>
          <select id="bulk-outcome-type" required>
            <option value="">Select outcome...</option>
            <option value="contacted">Contacted</option>
            <option value="appointment_set">Appointment Set</option>
            <option value="listing_signed">Listing Signed</option>
            <option value="buyer_agreement">Buyer Agreement</option>
            <option value="closed_won">Closed Won</option>
            <option value="closed_lost">Closed Lost</option>
            <option value="invalid">Invalid</option>
          </select>
        </div>

        <div class="form-group">
          <label for="bulk-occurred-at">Occurred At</label>
          <input type="datetime-local" id="bulk-occurred-at">
          <small style="color: var(--text-muted);">Leave blank to use current time</small>
        </div>

        <div class="form-group">
          <label for="bulk-notes">Notes (optional)</label>
          <textarea id="bulk-notes" placeholder="Add notes for all selected leads..."></textarea>
        </div>

        <button type="submit" class="btn btn-primary">Apply to Selected Leads</button>
      </form>
    </div>
  </div>

  <script src="assets/admin.js"></script>
  <script>
    const tenantSlug = getTenantSlug();
    let currentLeads = [];
    let selectedLeads = new Set();

    async function searchLeads() {
      // In a real implementation, this would filter leads from the API
      // For now, using mock data or you'd add a filter endpoint
      showError('Lead filtering API not yet implemented. Coming soon!');

      // Mock implementation:
      currentLeads = [
        { id: 'lead_006', source_key: 'zillow', geo_key: 'columbus_oh', tier: 'B', last_activity_at: '2026-01-03T12:00:00Z' },
        { id: 'lead_007', source_key: 'organic_search', geo_key: 'westerville_oh', tier: 'A', last_activity_at: '2026-01-14T12:00:00Z' },
      ];

      renderResults(currentLeads);
      document.getElementById('results-card').style.display = 'block';
      document.getElementById('action-card').style.display = 'block';
    }

    function renderResults(leads) {
      if (leads.length === 0) {
        document.getElementById('results-tbody').innerHTML = '<tr><td colspan="6" class="empty-state">No leads found</td></tr>';
        return;
      }

      const rows = leads.map(lead => `
        <tr>
          <td><input type="checkbox" class="lead-checkbox" data-lead-id="${lead.id}" onchange="updateSelection()"></td>
          <td><a href="lead-detail.html?id=${lead.id}">${lead.id}</a></td>
          <td>${lead.source_key}</td>
          <td>${lead.geo_key}</td>
          <td><span class="badge ${getTierBadge(lead.tier)}">${lead.tier}</span></td>
          <td>${formatDateTime(lead.last_activity_at)}</td>
        </tr>
      `).join('');

      document.getElementById('results-tbody').innerHTML = rows;
    }

    function getTierBadge(tier) {
      const map = { 'A': 'badge-success', 'B': 'badge-info', 'C': 'badge-warning', 'D': 'badge-danger' };
      return map[tier] || 'badge-info';
    }

    function toggleSelectAll() {
      const checked = document.getElementById('select-all').checked;
      document.querySelectorAll('.lead-checkbox').forEach(cb => {
        cb.checked = checked;
        if (checked) {
          selectedLeads.add(cb.dataset.leadId);
        } else {
          selectedLeads.delete(cb.dataset.leadId);
        }
      });
      updateSelectedCount();
    }

    function updateSelection() {
      selectedLeads.clear();
      document.querySelectorAll('.lead-checkbox:checked').forEach(cb => {
        selectedLeads.add(cb.dataset.leadId);
      });
      updateSelectedCount();
    }

    function updateSelectedCount() {
      document.getElementById('selected-count').textContent = `${selectedLeads.size} selected`;
    }

    document.getElementById('bulk-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      if (selectedLeads.size === 0) {
        showError('Please select at least one lead');
        return;
      }

      const outcomeType = document.getElementById('bulk-outcome-type').value;
      const occurredAt = document.getElementById('bulk-occurred-at').value;
      const notes = document.getElementById('bulk-notes').value;

      try {
        const result = await apiRequest(`/api/t/${tenantSlug}/outcomes/bulk`, {
          method: 'POST',
          body: JSON.stringify({
            lead_ids: Array.from(selectedLeads),
            outcome_type: outcomeType,
            occurred_at: occurredAt || undefined,
            notes: notes || undefined,
          }),
        });

        if (result.data.failed > 0) {
          showWarning(`Applied to ${result.data.successful} leads. ${result.data.failed} failed.`);
          console.error('Errors:', result.data.errors);
        } else {
          showSuccess(`Successfully applied outcome to ${result.data.successful} leads!`);
        }

        // Reset
        document.getElementById('bulk-form').reset();
        selectedLeads.clear();
        updateSelectedCount();
        document.querySelectorAll('.lead-checkbox').forEach(cb => cb.checked = false);
      } catch (error) {
        showError(error.message);
      }
    });
  </script>
</body>
</html>
