<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Missing Outcomes - Outcome Tracker</title>
  <link rel="stylesheet" href="assets/admin.css">
</head>
<body>
  <div class="header">
    <h1>Leads Needing Outcome Updates</h1>
  </div>

  <div class="container">
    <!-- Alert Summary -->
    <div id="alert-summary"></div>

    <!-- Lead List -->
    <div class="card">
      <h2 class="card-title">
        Stale Leads (7+ days without updates)
        <span id="selected-count" style="float: right; font-size: 0.875rem; font-weight: normal;">0 selected</span>
      </h2>

      <div id="loading" class="loading">Loading stale leads...</div>

      <div id="leads-content" style="display: none;">
        <table class="table">
          <thead>
            <tr>
              <th><input type="checkbox" id="select-all" onchange="toggleSelectAll()"></th>
              <th>Lead ID</th>
              <th>Source</th>
              <th>Geo</th>
              <th>Tier</th>
              <th>Days Stale</th>
              <th>Current Stage</th>
              <th>Last Activity</th>
            </tr>
          </thead>
          <tbody id="leads-tbody"></tbody>
        </table>

        <!-- Quick Actions -->
        <div style="margin-top: 1.5rem;">
          <button onclick="bulkAction('contacted')" class="btn btn-success">Mark as Contacted</button>
          <button onclick="bulkAction('invalid')" class="btn btn-danger" style="margin-left: 0.5rem;">Mark as Invalid</button>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/admin.js"></script>
  <script>
    const tenantSlug = getTenantSlug();
    let currentLeads = [];
    let selectedLeads = new Set();

    async function loadMissingOutcomes() {
      try {
        const result = await apiRequest(`/api/t/${tenantSlug}/outcomes/missing?limit=100`);
        currentLeads = result.data;

        if (currentLeads.length > 0) {
          renderAlertSummary(currentLeads.length);
          renderLeads(currentLeads);
        } else {
          document.getElementById('alert-summary').innerHTML = `
            <div class="alert alert-success">
              All high-value leads are up to date! üéâ
            </div>
          `;
        }

        document.getElementById('loading').style.display = 'none';
        document.getElementById('leads-content').style.display = currentLeads.length > 0 ? 'block' : 'none';
      } catch (error) {
        document.getElementById('loading').innerHTML = `<div class="alert alert-error">Error: ${error.message}</div>`;
      }
    }

    function renderAlertSummary(count) {
      document.getElementById('alert-summary').innerHTML = `
        <div class="alert alert-warning">
          <strong>‚ö†Ô∏è ${count} leads need outcome updates</strong><br>
          These high-value leads (Tier A/B) have not been updated in 7+ days.
        </div>
      `;
    }

    function renderLeads(leads) {
      const rows = leads.map(lead => `
        <tr>
          <td><input type="checkbox" class="lead-checkbox" data-lead-id="${lead.id}" onchange="updateSelection()"></td>
          <td><a href="lead-detail.html?id=${lead.id}">${lead.id}</a></td>
          <td>${lead.source_key}</td>
          <td>${lead.geo_key}</td>
          <td><span class="badge ${getTierBadge(lead.tier)}">${lead.tier}</span></td>
          <td><strong>${Math.round(lead.days_stale)}</strong></td>
          <td><span class="badge ${getStageBadge(lead.current_stage)}">${lead.current_stage || 'None'}</span></td>
          <td>${formatDateTime(lead.last_activity_at)}</td>
        </tr>
      `).join('');

      document.getElementById('leads-tbody').innerHTML = rows;
    }

    function getTierBadge(tier) {
      const map = { 'A': 'badge-success', 'B': 'badge-info', 'C': 'badge-warning', 'D': 'badge-danger' };
      return map[tier] || 'badge-info';
    }

    function getStageBadge(stage) {
      const map = {
        'top_of_funnel': 'badge-info',
        'mid_funnel': 'badge-warning',
        'won': 'badge-success',
        'lost': 'badge-danger',
        'invalid': 'badge-danger'
      };
      return map[stage] || 'badge-info';
    }

    function toggleSelectAll() {
      const checked = document.getElementById('select-all').checked;
      document.querySelectorAll('.lead-checkbox').forEach(cb => {
        cb.checked = checked;
        if (checked) {
          selectedLeads.add(cb.dataset.leadId);
        } else {
          selectedLeads.delete(cb.dataset.leadId);
        }
      });
      updateSelectedCount();
    }

    function updateSelection() {
      selectedLeads.clear();
      document.querySelectorAll('.lead-checkbox:checked').forEach(cb => {
        selectedLeads.add(cb.dataset.leadId);
      });
      updateSelectedCount();
    }

    function updateSelectedCount() {
      document.getElementById('selected-count').textContent = `${selectedLeads.size} selected`;
    }

    async function bulkAction(outcomeType) {
      if (selectedLeads.size === 0) {
        showError('Please select at least one lead');
        return;
      }

      if (!confirm(`Are you sure you want to mark ${selectedLeads.size} leads as "${outcomeType}"?`)) {
        return;
      }

      try {
        const result = await apiRequest(`/api/t/${tenantSlug}/outcomes/bulk`, {
          method: 'POST',
          body: JSON.stringify({
            lead_ids: Array.from(selectedLeads),
            outcome_type: outcomeType,
          }),
        });

        if (result.data.failed > 0) {
          showWarning(`Applied to ${result.data.successful} leads. ${result.data.failed} failed.`);
        } else {
          showSuccess(`Successfully marked ${result.data.successful} leads as ${outcomeType}!`);
        }

        // Reload
        selectedLeads.clear();
        updateSelectedCount();
        loadMissingOutcomes();
      } catch (error) {
        showError(error.message);
      }
    }

    // Initialize
    loadMissingOutcomes();
  </script>
</body>
</html>
