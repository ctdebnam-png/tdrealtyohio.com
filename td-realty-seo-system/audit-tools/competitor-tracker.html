<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Competitor Keyword Tracker - TD Realty SEO System</title>
  <link rel="stylesheet" href="../css/styles.css">
  <style>
    .rank-good { color: var(--success); font-weight: bold; }
    .rank-ok { color: var(--warning); }
    .rank-bad { color: var(--danger); }
    .rank-none { color: var(--text-muted); }
    .trend-up { color: var(--success); }
    .trend-down { color: var(--danger); }
    .trend-same { color: var(--text-muted); }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <a href="../index.html" class="logo">
        <div class="logo-icon">TD</div>
        <div>
          <div class="logo-text">Competitor Tracker</div>
          <div class="logo-subtitle">Keyword Rankings</div>
        </div>
      </a>
      <nav class="nav-links">
        <a href="../index.html" class="nav-link">Dashboard</a>
        <a href="title-checker.html" class="nav-link">Title Checker</a>
        <a href="meta-checker.html" class="nav-link">Meta Checker</a>
        <a href="schema-generator.html" class="nav-link">Schema</a>
        <a href="competitor-tracker.html" class="nav-link active">Rankings</a>
      </nav>
      <button class="theme-toggle" onclick="toggleTheme()">
        <span id="theme-icon">&#9790;</span>
      </button>
    </div>
  </header>

  <main class="container">
    <!-- Instructions -->
    <section class="card mb-4 fade-in">
      <div class="card-header">
        <h2 class="card-title">&#127919; How to Track Rankings</h2>
      </div>
      <div class="card-body">
        <p class="mb-2">Manually check your Google rankings weekly and log them here to track progress over time.</p>
        <ol class="text-sm text-muted">
          <li>Open an incognito/private browser window</li>
          <li>Search each keyword on Google</li>
          <li>Note your position (1-100) or "Not found"</li>
          <li>Do the same for competitors</li>
          <li>Enter the data below and save</li>
        </ol>
      </div>
    </section>

    <!-- Add New Entry -->
    <section class="card mb-4 fade-in">
      <div class="card-header">
        <h2 class="card-title">&#10133; Log Rankings</h2>
        <span class="text-muted text-sm">Last logged: <span id="last-logged">Never</span></span>
      </div>
      <div class="card-body">
        <div class="form-group">
          <label class="form-label">Date</label>
          <input type="date" class="form-input" id="entry-date" style="width: auto;">
        </div>

        <div class="table-container">
          <table class="table" id="entry-table">
            <thead>
              <tr>
                <th>Keyword</th>
                <th>TD Realty</th>
                <th>Homes That Click</th>
                <th>Sell for 1 Percent</th>
                <th>Sell 4 One Percent</th>
                <th>List With Clever</th>
              </tr>
            </thead>
            <tbody id="entry-body">
              <!-- Entry rows will be generated here -->
            </tbody>
          </table>
        </div>

        <div class="flex gap-2 mt-3">
          <button class="btn btn-primary" onclick="saveEntry()">Save Rankings</button>
          <button class="btn btn-secondary" onclick="clearEntry()">Clear</button>
        </div>
      </div>
    </section>

    <!-- Rankings History -->
    <section class="card mb-4 fade-in">
      <div class="card-header">
        <h2 class="card-title">&#128200; Rankings History</h2>
        <div class="flex gap-2">
          <select class="form-select" id="keyword-filter" style="width: auto;" onchange="renderHistory()">
            <option value="">All Keywords</option>
          </select>
          <button class="btn btn-sm btn-outline" onclick="exportData()">Export CSV</button>
        </div>
      </div>
      <div class="card-body">
        <div class="table-container">
          <table class="table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Keyword</th>
                <th>TD Realty</th>
                <th>Trend</th>
                <th>Homes That Click</th>
                <th>Sell for 1%</th>
                <th>Sell 4 One%</th>
                <th>Clever</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="history-body">
              <!-- History rows -->
            </tbody>
          </table>
        </div>
        <div id="no-data" class="empty-state" style="display: none;">
          <div class="empty-state-icon">&#128202;</div>
          <div class="empty-state-title">No data yet</div>
          <p>Start tracking rankings by entering your first data point above.</p>
        </div>
      </div>
    </section>

    <!-- Trend Charts (Simple visual) -->
    <section class="card fade-in">
      <div class="card-header">
        <h2 class="card-title">&#128200; Ranking Trends</h2>
        <select class="form-select" id="chart-keyword" style="width: auto;" onchange="renderChart()">
          <!-- Populated dynamically -->
        </select>
      </div>
      <div class="card-body">
        <div id="chart-container" style="min-height: 200px;">
          <div class="text-center text-muted">Select a keyword to view trend</div>
        </div>
      </div>
    </section>
  </main>

  <script src="../js/app.js"></script>
  <script>
    const targetKeywords = [
      '1% commission realtor Columbus Ohio',
      'discount realtor Columbus Ohio',
      'sell house for less Columbus',
      'low commission realtor Columbus',
      '1 percent listing fee Ohio',
      'flat fee realtor Columbus',
      'cheap realtor Columbus Ohio',
      'save money selling house Columbus'
    ];

    const competitors = [
      { id: 'tdrealty', name: 'TD Realty' },
      { id: 'homesthatclick', name: 'Homes That Click' },
      { id: 'sellfor1percent', name: 'Sell for 1 Percent' },
      { id: 'sell4onepercent', name: 'Sell 4 One Percent' },
      { id: 'listwithclever', name: 'List With Clever' }
    ];

    let rankingsData = [];

    document.addEventListener('DOMContentLoaded', () => {
      loadData();
      generateEntryTable();
      populateFilters();
      renderHistory();
      updateLastLogged();
      document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
      document.getElementById('theme-icon').innerHTML = TDR.ThemeManager.isDark() ? '&#9788;' : '&#9790;';
    });

    function loadData() {
      rankingsData = TDR.DataManager.get(TDR.STORAGE_KEYS.RANKINGS, []);
    }

    function saveData() {
      TDR.DataManager.set(TDR.STORAGE_KEYS.RANKINGS, rankingsData);
    }

    function generateEntryTable() {
      const tbody = document.getElementById('entry-body');
      tbody.innerHTML = targetKeywords.map((keyword, i) => `
        <tr>
          <td class="text-sm">${keyword}</td>
          ${competitors.map(c => `
            <td>
              <input type="number" class="form-input" id="rank-${i}-${c.id}"
                     min="1" max="100" placeholder="1-100" style="width: 80px;">
            </td>
          `).join('')}
        </tr>
      `).join('');
    }

    function populateFilters() {
      const select = document.getElementById('keyword-filter');
      const chartSelect = document.getElementById('chart-keyword');

      targetKeywords.forEach(kw => {
        select.innerHTML += `<option value="${kw}">${kw}</option>`;
        chartSelect.innerHTML += `<option value="${kw}">${kw}</option>`;
      });
    }

    function saveEntry() {
      const date = document.getElementById('entry-date').value;
      if (!date) {
        alert('Please select a date');
        return;
      }

      targetKeywords.forEach((keyword, i) => {
        const entry = {
          date,
          keyword,
          rankings: {}
        };

        competitors.forEach(c => {
          const input = document.getElementById(`rank-${i}-${c.id}`);
          const value = input.value ? parseInt(input.value) : null;
          entry.rankings[c.id] = value;
        });

        // Only save if at least one ranking is entered
        if (Object.values(entry.rankings).some(v => v !== null)) {
          // Check if entry for this date/keyword already exists
          const existingIndex = rankingsData.findIndex(e => e.date === date && e.keyword === keyword);
          if (existingIndex >= 0) {
            rankingsData[existingIndex] = entry;
          } else {
            rankingsData.push(entry);
          }
        }
      });

      saveData();
      renderHistory();
      updateLastLogged();
      alert('Rankings saved!');
    }

    function clearEntry() {
      document.querySelectorAll('#entry-body input').forEach(input => input.value = '');
    }

    function renderHistory() {
      const tbody = document.getElementById('history-body');
      const filter = document.getElementById('keyword-filter').value;
      const noData = document.getElementById('no-data');

      let filtered = [...rankingsData];
      if (filter) {
        filtered = filtered.filter(e => e.keyword === filter);
      }

      // Sort by date descending
      filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

      if (filtered.length === 0) {
        tbody.innerHTML = '';
        noData.style.display = 'block';
        return;
      }

      noData.style.display = 'none';

      tbody.innerHTML = filtered.slice(0, 50).map(entry => {
        const trend = calculateTrend(entry.keyword, entry.date, entry.rankings.tdrealty);
        return `
          <tr>
            <td class="text-sm">${TDR.Utils.formatDate(entry.date)}</td>
            <td class="text-sm">${entry.keyword}</td>
            <td class="${getRankClass(entry.rankings.tdrealty)}">${formatRank(entry.rankings.tdrealty)}</td>
            <td class="${trend.class}">${trend.text}</td>
            <td class="${getRankClass(entry.rankings.homesthatclick)}">${formatRank(entry.rankings.homesthatclick)}</td>
            <td class="${getRankClass(entry.rankings.sellfor1percent)}">${formatRank(entry.rankings.sellfor1percent)}</td>
            <td class="${getRankClass(entry.rankings.sell4onepercent)}">${formatRank(entry.rankings.sell4onepercent)}</td>
            <td class="${getRankClass(entry.rankings.listwithclever)}">${formatRank(entry.rankings.listwithclever)}</td>
            <td>
              <button class="btn btn-sm btn-danger" onclick="deleteEntry('${entry.date}', '${entry.keyword}')" style="padding: 0.25rem 0.5rem;">
                &#10005;
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function getRankClass(rank) {
      if (!rank) return 'rank-none';
      if (rank <= 10) return 'rank-good';
      if (rank <= 30) return 'rank-ok';
      return 'rank-bad';
    }

    function formatRank(rank) {
      return rank ? `#${rank}` : '-';
    }

    function calculateTrend(keyword, currentDate, currentRank) {
      if (!currentRank) return { text: '-', class: 'trend-same' };

      // Find previous entry for this keyword
      const previousEntries = rankingsData
        .filter(e => e.keyword === keyword && e.date < currentDate && e.rankings.tdrealty)
        .sort((a, b) => new Date(b.date) - new Date(a.date));

      if (previousEntries.length === 0) {
        return { text: 'NEW', class: 'trend-same' };
      }

      const previousRank = previousEntries[0].rankings.tdrealty;
      const diff = previousRank - currentRank;

      if (diff > 0) {
        return { text: `+${diff}`, class: 'trend-up' };
      } else if (diff < 0) {
        return { text: `${diff}`, class: 'trend-down' };
      }
      return { text: '=', class: 'trend-same' };
    }

    function deleteEntry(date, keyword) {
      if (!confirm('Delete this entry?')) return;
      rankingsData = rankingsData.filter(e => !(e.date === date && e.keyword === keyword));
      saveData();
      renderHistory();
    }

    function updateLastLogged() {
      const dates = rankingsData.map(e => e.date).sort();
      const last = dates.length > 0 ? TDR.Utils.formatDate(dates[dates.length - 1]) : 'Never';
      document.getElementById('last-logged').textContent = last;
    }

    function renderChart() {
      const keyword = document.getElementById('chart-keyword').value;
      const container = document.getElementById('chart-container');

      if (!keyword) {
        container.innerHTML = '<div class="text-center text-muted">Select a keyword to view trend</div>';
        return;
      }

      const entries = rankingsData
        .filter(e => e.keyword === keyword && e.rankings.tdrealty)
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      if (entries.length === 0) {
        container.innerHTML = '<div class="text-center text-muted">No data for this keyword yet</div>';
        return;
      }

      // Simple text-based chart
      const maxRank = 100;
      const chartHtml = `
        <div class="mb-3">
          <strong>${keyword}</strong>
          <span class="text-muted text-sm"> - TD Realty ranking over time</span>
        </div>
        <div style="display: flex; align-items: flex-end; gap: 4px; height: 150px; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;">
          ${entries.slice(-12).map(e => {
            const rank = e.rankings.tdrealty;
            const height = ((maxRank - rank) / maxRank) * 100;
            const color = rank <= 10 ? 'var(--success)' : rank <= 30 ? 'var(--warning)' : 'var(--danger)';
            return `
              <div style="flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: flex-end;">
                <span class="text-xs">#${rank}</span>
                <div style="width: 100%; max-width: 40px; height: ${Math.max(height, 5)}%; background: ${color}; border-radius: 4px 4px 0 0;"></div>
              </div>
            `;
          }).join('')}
        </div>
        <div style="display: flex; gap: 4px; margin-top: 0.5rem;">
          ${entries.slice(-12).map(e => `
            <div style="flex: 1; text-align: center;">
              <span class="text-xs text-muted">${new Date(e.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}</span>
            </div>
          `).join('')}
        </div>
        <div class="mt-3 text-sm">
          <strong>Summary:</strong>
          Best rank: #${Math.min(...entries.map(e => e.rankings.tdrealty))} |
          Current: #${entries[entries.length - 1].rankings.tdrealty} |
          Data points: ${entries.length}
        </div>
      `;

      container.innerHTML = chartHtml;
    }

    function exportData() {
      if (rankingsData.length === 0) {
        alert('No data to export');
        return;
      }

      const headers = ['Date', 'Keyword', 'TD Realty', 'Homes That Click', 'Sell for 1%', 'Sell 4 One%', 'Clever'];
      const rows = rankingsData.map(e => [
        e.date,
        e.keyword,
        e.rankings.tdrealty || '',
        e.rankings.homesthatclick || '',
        e.rankings.sellfor1percent || '',
        e.rankings.sell4onepercent || '',
        e.rankings.listwithclever || ''
      ]);

      const csv = [headers, ...rows].map(row => row.map(cell => `"${cell}"`).join(',')).join('\n');
      TDR.ExportManager.download(csv, `td-realty-rankings-${new Date().toISOString().split('T')[0]}.csv`, 'text/csv');
    }

    function toggleTheme() {
      TDR.ThemeManager.toggle();
      document.getElementById('theme-icon').innerHTML = TDR.ThemeManager.isDark() ? '&#9788;' : '&#9790;';
    }
  </script>
</body>
</html>
