name: Facebook Audience Sync

on:
  schedule:
    # Run weekly on Sundays at 3 AM EST (8 AM UTC)
    - cron: '0 8 * * 0'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (do not sync)'
        type: boolean
        default: false

env:
  APPS_SCRIPT_URL: ${{ secrets.APPS_SCRIPT_URL }}
  APPS_SCRIPT_TOKEN: ${{ secrets.APPS_SCRIPT_TOKEN }}
  FACEBOOK_ACCESS_TOKEN: ${{ secrets.FACEBOOK_ACCESS_TOKEN }}
  FACEBOOK_AD_ACCOUNT_ID: ${{ secrets.FACEBOOK_AD_ACCOUNT_ID }}

jobs:
  sync-audiences:
    name: Sync to Facebook Custom Audiences
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r td-seller-intelligence/requirements.txt

      - name: Sync Facebook Audiences
        working-directory: td-seller-intelligence
        run: |
          python -m scripts.sync.facebook_sync \
            ${{ github.event.inputs.dry_run == 'true' && '--dry-run' || '' }} \
            --verbose
