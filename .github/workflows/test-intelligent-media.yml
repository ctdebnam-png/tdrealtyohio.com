name: Test Intelligent Media System

on:
  workflow_dispatch: # Manual trigger
  push:
    branches:
      - claude/automated-media-management-CCrSl

jobs:
  test-secrets:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Test API secret access
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: npm run test:secrets

      - name: Test API connections
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: npm run test:connections

  test-intelligent-media:
    runs-on: ubuntu-latest
    needs: test-secrets

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm install

      - name: Validate system
        run: npm run intelligent:validate

      - name: Run test (5 images)
        env:
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          PIXABAY_API_KEY: ${{ secrets.PIXABAY_API_KEY }}
          UNSPLASH_ACCESS_KEY: ${{ secrets.UNSPLASH_ACCESS_KEY }}
        run: |
          # Run a small test with just 1 page to verify system works
          cd scripts/intelligent-media
          node -e "
            const IntelligentMediaManager = require('./index');
            const manager = new IntelligentMediaManager({
              autoApprove: true,
              dryRun: false
            });

            async function test() {
              await manager.init();
              const result = await manager.processPage('hero', 'homepage');
              console.log('Test result:', result.success ? '✅ SUCCESS' : '❌ FAILED');
              await manager.close();
            }

            test();
          "

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: test-output
          path: |
            assets/media/intelligent/**
            data/intelligent-media.db
            image-gallery.html
